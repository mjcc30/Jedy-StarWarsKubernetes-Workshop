---
import { ViewTransitions } from "astro:transitions";
import "../styles/starwind.css";

interface Props {
  title: string;
}

const { title } = Astro.props;
---

<!doctype html>
<html lang="en" data-theme="black">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="Explore the Star Wars Galaxy" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <ViewTransitions />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body class="min-h-screen flex flex-col">
    <!-- Navbar -->
    <div class="navbar glass-panel sticky top-0 z-50 mb-8">
      <div class="flex-1">
        <a
          href="/"
          class="btn btn-ghost text-xl font-orbitron text-yellow-400 tracking-widest"
        >
          JEDY <span class="text-white">ARCHIVES</span>
        </a>
      </div>
      <div class="flex-none gap-2">
        <ul class="menu menu-horizontal px-1">
          <!-- Game Launcher -->
          <li>
            <button
              id="start-game-btn"
              class="text-yellow-400 hover:text-red-500 font-orbitron text-sm tracking-widest border border-yellow-400/30 hover:border-red-500/50 rounded-none transition-all"
            >
              <span class="mr-1">⚔</span> GALACTIC DEFENSE
            </button>
          </li>
        </ul>

        <!-- Guest Menu (Visible if NOT logged in) -->
        <div id="guest-menu" class="hidden flex gap-2">
          <a
            href="/login"
            class="btn btn-sm btn-ghost text-yellow-400 font-orbitron tracking-wider hover:bg-yellow-400/20"
            >LOGIN</a
          >
          <a
            href="/register"
            class="btn btn-sm bg-yellow-400 text-black border-none font-orbitron tracking-wider hover:bg-yellow-300"
            >REGISTER</a
          >
        </div>

        <!-- User Menu (Visible if logged in) -->
        <div id="user-menu" class="hidden dropdown dropdown-end">
          <div
            tabindex="0"
            role="button"
            class="btn btn-ghost btn-circle avatar placeholder"
          >
            <div
              class="bg-neutral text-neutral-content rounded-full w-10 ring ring-yellow-400 ring-offset-black ring-offset-2"
            >
              <span class="text-xs font-bold text-yellow-400">JEDI</span>
            </div>
          </div>
          <ul
            tabindex="0"
            class="menu menu-sm dropdown-content bg-black/90 border border-yellow-400/30 rounded-box z-[1] mt-3 w-52 p-2 shadow glass-panel"
          >
            <li class="menu-title text-gray-400">My Account</li>
            <li>
              <a
                href="/login"
                id="logout-btn"
                class="text-red-400 hover:text-red-300 hover:bg-red-900/20"
                >Logout</a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <main class="container mx-auto px-4 py-8 flex-grow">
      <slot />
    </main>

    <footer
      class="footer items-center p-4 bg-black text-neutral-content mt-auto glass-panel border-t border-white/10"
    >
      <aside class="items-center grid-flow-col">
        <p>
          Copyright © {new Date().getFullYear()} - All right reserved by The Galactic
          Empire
        </p>
      </aside>
    </footer>

    <!-- GAME OVERLAY -->
    <div
      id="game-overlay"
      class="fixed inset-0 z-[100] bg-black hidden flex-col items-center justify-center"
    >
      <div id="game-container" class="absolute inset-0 w-full h-full"></div>

      <!-- Game UI -->
      <div
        class="absolute top-4 left-4 text-yellow-400 font-orbitron text-xl select-none z-50 pointer-events-none"
      >
        SCORE: <span id="score-display">0</span>
      </div>
      <button
        id="close-game-btn"
        class="absolute top-4 right-4 btn btn-circle btn-sm bg-red-500 text-white border-none hover:bg-red-600 z-50 pointer-events-auto"
        >✕</button
      >

      <!-- Start/Game Over Screen -->
      <div
        id="game-menu"
        class="absolute inset-0 flex flex-col items-center justify-center bg-black/80 backdrop-blur-sm text-center z-50"
      >
        <h1 class="text-6xl font-orbitron text-yellow-400 mb-4 glow-text">
          GALACTIC DEFENSE 3D
        </h1>
        <p class="text-white mb-8 font-mono">
          PILOT: <span class="text-blue-400">MILLENNIUM FALCON</span>
          <br /> MISSION: DESTROY TIE FIGHTERS
        </p>
        <div class="text-sm text-gray-400 mb-8">
          [ ← / → ] TO MOVE • [ SPACE ] TO FIRE
        </div>
        <button
          id="play-btn"
          class="btn btn-lg bg-yellow-400 text-black font-bold font-orbitron border-none hover:bg-yellow-300 px-12 pointer-events-auto"
        >
          ENGAGE SYSTEMS
        </button>
      </div>
    </div>

    <style>
      .glow-text {
        text-shadow: 0 0 20px rgba(255, 232, 31, 0.6);
      }
    </style>

    <script>
      import * as THREE from "three";
      import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";

      // Auth UI Logic
      const token = localStorage.getItem("token");
      const guestMenu = document.getElementById("guest-menu");
      const userMenu = document.getElementById("user-menu");

      if (token) {
        userMenu?.classList.remove("hidden");
      } else {
        guestMenu?.classList.remove("hidden");
      }

      // Logout Logic
      const logoutBtn = document.getElementById("logout-btn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", (e) => {
          localStorage.removeItem("token");
        });
      }

      // --- 3D SPACE SHOOTER ENGINE ---
      const gameBtn = document.getElementById("start-game-btn");
      const closeGameBtn = document.getElementById("close-game-btn");
      const overlay = document.getElementById("game-overlay");
      const container = document.getElementById("game-container");
      const menu = document.getElementById("game-menu");
      const playBtn = document.getElementById("play-btn");
      const scoreDisplay = document.getElementById("score-display");

      let scene, camera, renderer;
      let player, stars;
      let lasers = [];
      let enemies = [];
      let particles = [];
      let score = 0;
      let isGameOver = false;
      let isPlaying = false;
      let animationId;

      // Loaded Assets
      let falconModel = null;
      let tieModel = null;
      let modelsLoaded = false;

      const keys = { ArrowLeft: false, ArrowRight: false, Space: false };
      let clock = new THREE.Clock();
      let spawnTimer = 0;
      let spawnInterval = 2.0;

      const PLAYER_SPEED = 15.0;
      const LASER_SPEED = 40.0;
      const ENEMY_SPEED_BASE = 8.0;

      function initThreeJS() {
        if (!container) return;

        // Cleanup previous scene if exists
        while (container.firstChild)
          container.removeChild(container.firstChild);

        // Scene
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.02);

        // Camera
        camera = new THREE.PerspectiveCamera(
          75,
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );
        camera.position.set(0, 5, 10);
        camera.lookAt(0, 0, -10);

        // Renderer
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        container.appendChild(renderer.domElement);

        // Lights
        const ambientLight = new THREE.AmbientLight(0x404040, 3);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 2);
        dirLight.position.set(5, 10, 7);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // Starfield (Warp Speed Effect)
        const starGeometry = new THREE.BufferGeometry();
        const starCount = 1000;
        const starPos = new Float32Array(starCount * 3);
        for (let i = 0; i < starCount * 3; i++) {
          starPos[i] = (Math.random() - 0.5) * 200;
        }
        starGeometry.setAttribute(
          "position",
          new THREE.BufferAttribute(starPos, 3)
        );
        const starMaterial = new THREE.PointsMaterial({
          color: 0xffffff,
          size: 0.5,
        });
        stars = new THREE.Points(starGeometry, starMaterial);
        scene.add(stars);

        clock = new THREE.Clock();

        // Start loading models immediately if not already loaded
        if (!modelsLoaded) loadModels();
      }

      function loadModels() {
        const loader = new GLTFLoader();
        const loadingManager = new THREE.LoadingManager();

        // Safety Timeout: If models fail/take too long, enable game anyway
        const safetyTimeout = setTimeout(() => {
          if (!modelsLoaded) {
            console.warn("Model loading timed out. Using fallback assets.");
            loadingManager.onLoad();
          }
        }, 3000);

        loadingManager.onLoad = () => {
          clearTimeout(safetyTimeout);
          modelsLoaded = true;
          if (playBtn) playBtn.innerText = "ENGAGE SYSTEMS";
          if (playBtn) playBtn.disabled = false;
        };

        // Disable play button while loading
        if (playBtn) {
          playBtn.innerText = "LOADING ASSETS...";
          playBtn.disabled = true;
        }

        loader.load("/millennium_falcon.glb", (gltf) => {
          falconModel = gltf.scene;
          falconModel.traverse((node) => {
            if (node.isMesh) {
              node.castShadow = true;
              node.receiveShadow = true;
            }
          });
          // Falcon adjustments - drastically reduced scale
          falconModel.scale.set(0.02, 0.02, 0.02);
          falconModel.rotation.y = Math.PI; // Face forward (away from camera) if model faces +Z
        });

        loader.load("/star_wars_tieln_fighter.glb", (gltf) => {
          tieModel = gltf.scene;
          tieModel.traverse((node) => {
            if (node.isMesh) {
              node.castShadow = true;
              node.receiveShadow = true;
            }
          });
          // TIE adjustments
          tieModel.scale.set(0.02, 0.02, 0.02);
          tieModel.rotation.y = Math.PI;
        });
      }

      function createFalcon() {
        if (falconModel) {
          return falconModel.clone();
        }
        // Fallback geometry if model not loaded/failed
        const falcon = new THREE.Mesh(
          new THREE.BoxGeometry(2, 0.5, 3),
          new THREE.MeshStandardMaterial({ color: 0xcccccc })
        );
        return falcon;
      }

      function createTIE() {
        if (tieModel) {
          return tieModel.clone();
        }
        // Fallback geometry
        const tie = new THREE.Mesh(
          new THREE.SphereGeometry(1),
          new THREE.MeshStandardMaterial({ color: 0x333333 })
        );
        return tie;
      }

      // ... [createExplosion remains unchanged] ...
      function createExplosion(position) {
        const count = 15;
        for (let i = 0; i < count; i++) {
          const geo = new THREE.BoxGeometry(0.2, 0.2, 0.2);
          const mat = new THREE.MeshBasicMaterial({ color: 0xffaa00 });
          const part = new THREE.Mesh(geo, mat);
          part.position.copy(position);
          part.userData.velocity = new THREE.Vector3(
            (Math.random() - 0.5) * 0.5,
            (Math.random() - 0.5) * 0.5,
            (Math.random() - 0.5) * 0.5
          );
          part.userData.life = 30;
          scene.add(part);
          particles.push(part);
        }
      }

      function startGame() {
        if (!scene) initThreeJS();

        // Reset state
        score = 0;
        scoreDisplay.innerText = "0";
        isPlaying = true;
        isGameOver = false;
        menu.classList.add("hidden");

        // Clear entities
        lasers.forEach((l) => scene.remove(l));
        enemies.forEach((e) => scene.remove(e));
        particles.forEach((p) => scene.remove(p));
        if (player) scene.remove(player);

        lasers = [];
        enemies = [];
        particles = [];

        player = createFalcon();
        player.position.set(0, 0, 5);
        scene.add(player);

        clock.start();
        spawnTimer = 0;
        spawnInterval = 2.0;

        gameLoop();
      }

      function gameLoop() {
        if (!isPlaying) return;
        animationId = requestAnimationFrame(gameLoop);

        const delta = clock.getDelta();
        const difficultyMultiplier = 1 + score * 0.0005;

        // --- Updates ---

        // Player Movement
        if (keys.ArrowLeft && player.position.x > -12) {
          player.position.x -= PLAYER_SPEED * delta;
          player.rotation.z = 0.3;
        } else if (keys.ArrowRight && player.position.x < 12) {
          player.position.x += PLAYER_SPEED * delta;
          player.rotation.z = -0.3;
        } else {
          player.rotation.z *= 0.9;
        }

        // Spawn Enemies
        spawnTimer += delta;
        const currentSpawnInterval = Math.max(0.5, 2.0 - score * 0.001);

        if (spawnTimer > currentSpawnInterval) {
          const enemy = createTIE();
          enemy.position.set((Math.random() - 0.5) * 20, 0, -50);
          scene.add(enemy);
          enemies.push(enemy);
          spawnTimer = 0;
        }

        // Lasers
        lasers.forEach((laser, i) => {
          laser.position.z -= LASER_SPEED * delta;
          if (laser.position.z < -60) {
            scene.remove(laser);
            lasers.splice(i, 1);
          }
        });

        // Enemies
        const playerBox = new THREE.Box3().setFromObject(player);
        playerBox.expandByScalar(-0.5);

        for (let i = enemies.length - 1; i >= 0; i--) {
          const enemy = enemies[i];
          enemy.position.z += ENEMY_SPEED_BASE * difficultyMultiplier * delta;

          // Only rotate if it's our fallback geometry or if the model orientation allows it nicely
          // TIE models often look weird if spun on Z axis like a wheel, so maybe slight banking instead
          // enemy.rotation.z += 2.0 * delta;

          // Collision with Player
          const enemyBox = new THREE.Box3().setFromObject(enemy);
          if (playerBox.intersectsBox(enemyBox)) {
            createExplosion(player.position);
            endGame();
            return;
          }

          // Passed player?
          if (enemy.position.z > 10) {
            scene.remove(enemy);
            enemies.splice(i, 1);
          }

          // Collision with Lasers
          for (let j = lasers.length - 1; j >= 0; j--) {
            const laser = lasers[j];
            const laserBox = new THREE.Box3().setFromObject(laser);
            if (laserBox.intersectsBox(enemyBox)) {
              createExplosion(enemy.position);
              scene.remove(enemy);
              scene.remove(laser);
              enemies.splice(i, 1);
              lasers.splice(j, 1);
              score += 100;
              scoreDisplay.innerText = score;
              break;
            }
          }
        }

        // Particles
        for (let i = particles.length - 1; i >= 0; i--) {
          const p = particles[i];
          p.position.addScaledVector(p.userData.velocity, delta * 60);
          p.material.opacity -= 1.5 * delta;
          p.scale.multiplyScalar(0.95);
          if (p.material.opacity <= 0) {
            scene.remove(p);
            particles.splice(i, 1);
          }
        }

        // Starfield Effect
        const positions = stars.geometry.attributes.position.array;
        for (let i = 2; i < positions.length; i += 3) {
          positions[i] += 40 * delta;
          if (positions[i] > 20) positions[i] = -150;
        }
        stars.geometry.attributes.position.needsUpdate = true;

        // Render
        renderer.render(scene, camera);
      }

      function endGame() {
        isPlaying = false;
        cancelAnimationFrame(animationId);
        menu.classList.remove("hidden");
        const h1 = menu.querySelector("h1");
        h1.innerText = "SYSTEM FAILURE";
        h1.classList.add("text-red-500");
        h1.classList.remove("text-yellow-400");
        playBtn.innerText = "REBOOT SYSTEMS";
        playBtn.disabled = false;
      }

      // Controls
      window.addEventListener("keydown", (e) => {
        if (e.code === "ArrowLeft") keys.ArrowLeft = true;
        if (e.code === "ArrowRight") keys.ArrowRight = true;
        if (e.code === "Space") {
          if (!keys.Space && isPlaying) {
            const laserGeo = new THREE.CylinderGeometry(0.1, 0.1, 2);
            const laserMat = new THREE.MeshBasicMaterial({ color: 0x00ff00 }); // Green lasers for rebels
            const laser = new THREE.Mesh(laserGeo, laserMat);
            laser.rotation.x = Math.PI / 2;
            laser.position.copy(player.position);
            laser.position.y -= 0.5;

            const l1 = laser.clone();
            l1.position.x -= 0.8;
            const l2 = laser.clone();
            l2.position.x += 0.8;

            scene.add(l1);
            scene.add(l2);
            lasers.push(l1, l2);
          }
          keys.Space = true;
        }
      });

      window.addEventListener("keyup", (e) => {
        if (e.code === "ArrowLeft") keys.ArrowLeft = false;
        if (e.code === "ArrowRight") keys.ArrowRight = false;
        if (e.code === "Space") keys.Space = false;
      });

      // UI Events
      if (gameBtn) {
        gameBtn.addEventListener("click", () => {
          overlay.classList.remove("hidden");
          overlay.classList.add("flex");
          initThreeJS(); // Init scene and start loading models
        });
      }

      if (closeGameBtn) {
        closeGameBtn.addEventListener("click", () => {
          isPlaying = false;
          cancelAnimationFrame(animationId);
          overlay.classList.add("hidden");
          overlay.classList.remove("flex");
        });
      }

      if (playBtn) {
        playBtn.addEventListener("click", () => {
          const h1 = menu.querySelector("h1");
          h1.innerText = "GALACTIC DEFENSE 3D";
          h1.classList.remove("text-red-500");
          h1.classList.add("text-yellow-400");
          startGame();
        });
      }

      window.addEventListener("resize", () => {
        if (camera && renderer) {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        }
      });
    </script>
  </body>
</html>
