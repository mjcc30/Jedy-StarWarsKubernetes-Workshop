---
import Layout from "../layouts/Layout.astro";
import Search from "../components/Search.astro";
import { Icon } from "astro-icon/components";
---

<Layout title="Jedy StarWars - Archives">
  <!-- Hero Section -->
  <div
    class="relative min-h-[60vh] flex items-center justify-center overflow-hidden rounded-3xl mb-16"
  >
    <!-- Animated background overlay -->
    <div
      class="absolute inset-0 bg-gradient-to-b from-transparent to-black z-10"
    >
    </div>
    <div
      class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072&auto=format&fit=crop')] bg-cover bg-center opacity-40"
    >
    </div>

    <div class="relative z-20 text-center px-4 max-w-4xl mx-auto">
      <h1
        class="text-6xl md:text-8xl font-black mb-6 animate-fade-in-down drop-shadow-[0_0_15px_rgba(255,232,31,0.5)]"
      >
        GALACTIC <span
          class="text-white block text-4xl md:text-6xl mt-2 tracking-[0.5em] font-light"
          >ARCHIVES</span
        >
      </h1>
      <p
        class="text-xl md:text-2xl text-gray-300 mb-8 font-light max-w-2xl mx-auto"
      >
        Access the complete database of the Republic. Search for any known
        entity across the galaxy.
      </p>
      <a
        href="#search-section"
        class="btn bg-yellow-400 text-black border-none hover:bg-yellow-300 font-bold px-8 py-3 h-auto text-lg rounded-full"
      >
        Begin Search
      </a>
    </div>
  </div>

  <!-- Search Section -->
  <section id="search-section" class="py-8 scroll-mt-24">
    <div class="text-center mb-12">
      <div
        class="inline-block p-3 rounded-full bg-white/5 mb-4 border border-white/10"
      >
        <Icon name="mdi:telescope" class="w-8 h-8 text-yellow-400" />
      </div>
      <h2 class="text-4xl font-bold mb-2">Search the Galaxy</h2>
      <p class="text-gray-400">Filter by category to find specific records</p>
    </div>
    <Search />
  </section>

  <!-- Featured Section -->
  <section class="py-24 border-t border-white/10 mt-16">
    <div class="max-w-5xl mx-auto">
      <div class="flex flex-col md:flex-row items-center gap-12">
        <div class="md:w-1/2">
          <h2 class="text-4xl font-bold mb-6 text-left">Featured Entity</h2>
          <p class="text-gray-300 text-lg mb-6 leading-relaxed">
            The Force guides us to random knowledge. Discover a randomly
            selected entry from our vast database. Every visit brings a new
            discovery from the archives.
          </p>
          <div class="flex gap-4">
            <div class="badge badge-outline text-yellow-400 p-4">
              Random Selection
            </div>
            <div class="badge badge-outline text-blue-400 p-4">
              Verified Data
            </div>
          </div>
        </div>

        <div class="md:w-1/2 w-full" id="featured-container">
          <!-- Placeholder for featured content -->
          <div
            class="sw-card h-64 flex flex-col items-center justify-center border border-dashed border-white/20"
          >
            <span class="loading loading-ring loading-lg text-yellow-400"
            ></span>
            <p class="mt-4 text-xs tracking-widest text-gray-500">
              RETRIEVING DATA...
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const featuredContainer = document.getElementById("featured-container");

      if (featuredContainer) {
        try {
          // We pick one resource type randomly
          const resources = ["people", "planets", "starships"];
          const randomResource =
            resources[Math.floor(Math.random() * resources.length)];

          // Search with empty query usually returns a list, or we search for a common letter like 'a' to get results
          const response = await fetch(
            `/api/swapi/search?resource=${randomResource}&query=a`
          );

          if (response.ok) {
            const data = await response.json();
            const items = data.results;

            if (items && items.length > 0) {
              const randomItem =
                items[Math.floor(Math.random() * items.length)];

              // Map some common fields for display
              const details = Object.entries(randomItem)
                .slice(0, 4) // Just take first 4 properties for the featured card
                .map(([key, value]) => {
                  if (
                    typeof value !== "string" ||
                    key === "url" ||
                    key === "created" ||
                    key === "edited" ||
                    key === "films" ||
                    key === "vehicles" ||
                    key === "starships" ||
                    key === "residents" ||
                    key === "people" ||
                    key === "pilots"
                  )
                    return null;
                  return `<div class="flex justify-between border-b border-white/10 py-2"><span class="text-gray-400 capitalize">${key.replace(/_/g, " ")}</span> <span class="text-white text-right truncate pl-4 max-w-[150px]">${value}</span></div>`;
                })
                .filter(Boolean)
                .join("");

              featuredContainer.innerHTML = `
                <div class="sw-card transform rotate-2 hover:rotate-0 transition-transform duration-500">
                  <div class="relative h-48 bg-gray-900 overflow-hidden">
                    <div class="absolute inset-0 bg-yellow-400/10 mix-blend-overlay z-10"></div>
                     <img src="https://picsum.photos/seed/${randomItem.name.replace(/\s/g, "")}/600/300" class="w-full h-full object-cover opacity-80" alt="Random Star Wars" />
                     <div class="absolute bottom-0 left-0 p-4 bg-gradient-to-t from-black to-transparent w-full z-20">
                        <span class="badge bg-yellow-400 text-black border-none font-bold mb-2 uppercase text-xs">${randomResource}</span>
                        <h3 class="text-3xl font-orbitron text-white">${randomItem.name}</h3>
                     </div>
                  </div>
                  <div class="p-6 bg-white/5">
                    <div class="flex flex-col gap-1">
                      ${details}
                    </div>
                  </div>
                </div>
              `;
            } else {
              featuredContainer.innerHTML =
                '<div class="alert alert-warning">The archives are incomplete. No featured item found.</div>';
            }
          } else {
            featuredContainer.innerHTML =
              '<div class="alert alert-error">Communication error. Failed to fetch featured item.</div>';
          }
        } catch (error) {
          featuredContainer.innerHTML =
            '<div class="alert alert-error">System malfunction. An error occurred.</div>';
          console.error("Error fetching featured item:", error);
        }
      }
    });
  </script>
</Layout>
