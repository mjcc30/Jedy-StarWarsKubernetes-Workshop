---
import Layout from "../layouts/Layout.astro";
import { Icon } from "astro-icon/components";
---

<Layout title="Access Terminal - Login">
  <div class="flex items-center justify-center min-h-[60vh]">
    <div
      class="w-full max-w-md p-8 glass-panel rounded-2xl border border-white/10 relative overflow-hidden group"
    >
      <!-- Decorative corner accents -->
      <div
        class="absolute top-0 left-0 w-4 h-4 border-t-2 border-l-2 border-yellow-400"
      >
      </div>
      <div
        class="absolute top-0 right-0 w-4 h-4 border-t-2 border-r-2 border-yellow-400"
      >
      </div>
      <div
        class="absolute bottom-0 left-0 w-4 h-4 border-b-2 border-l-2 border-yellow-400"
      >
      </div>
      <div
        class="absolute bottom-0 right-0 w-4 h-4 border-b-2 border-r-2 border-yellow-400"
      >
      </div>

      <div class="text-center mb-8 relative z-10">
        <div
          class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-yellow-400/10 mb-4 text-yellow-400 ring-1 ring-yellow-400/50 shadow-[0_0_15px_rgba(255,232,31,0.3)]"
        >
          <Icon name="mdi:lock-open-variant" class="w-8 h-8" />
        </div>
        <h1 class="text-3xl font-bold font-orbitron tracking-widest text-white">
          IDENTIFICATION
        </h1>
        <p class="text-xs text-gray-400 mt-2 uppercase tracking-wider">
          Enter your credentials to access the archives
        </p>
      </div>

      <form id="login-form" class="space-y-6 relative z-10">
        <div class="form-control">
          <label for="username" class="label">
            <span
              class="label-text font-orbitron text-yellow-400 text-xs tracking-wider"
              >USERNAME</span
            >
          </label>
          <input
            type="text"
            id="username"
            name="username"
            class="input w-full bg-black/50 border border-white/20 focus:border-yellow-400 text-white placeholder-gray-600 transition-all duration-300 focus:shadow-[0_0_10px_rgba(255,232,31,0.3)] focus:outline-none"
            placeholder="TK-421"
            required
          />
        </div>

        <div class="form-control">
          <label for="password" class="label">
            <span
              class="label-text font-orbitron text-yellow-400 text-xs tracking-wider"
              >PASSPHRASE</span
            >
          </label>
          <input
            type="password"
            id="password"
            name="password"
            class="input w-full bg-black/50 border border-white/20 focus:border-yellow-400 text-white placeholder-gray-600 transition-all duration-300 focus:shadow-[0_0_10px_rgba(255,232,31,0.3)] focus:outline-none"
            placeholder="••••••••"
            required
          />
        </div>

        <div class="form-control mt-8">
          <button
            type="submit"
            class="btn bg-yellow-400 text-black border-none hover:bg-yellow-300 font-bold font-orbitron tracking-widest w-full"
          >
            <Icon name="mdi:login" class="w-5 h-5 mr-2" />
            INITIATE LOGIN
          </button>
        </div>

        <div class="text-center mt-4">
          <a
            href="/register"
            class="text-xs text-gray-400 hover:text-yellow-400 transition-colors uppercase tracking-wider"
          >
            New Recruit? Enlist Here
          </a>
        </div>

        <div
          id="error-message"
          class="text-red-400 text-sm text-center mt-4 font-mono hidden"
        >
        </div>
        <div
          id="success-message"
          class="text-green-400 text-sm text-center mt-4 font-mono hidden"
        >
        </div>
      </form>
    </div>
  </div>
</Layout>

<script>
  const form = document.getElementById("login-form") as HTMLFormElement;
  const errorMessage = document.getElementById("error-message");
  const successMessage = document.getElementById("success-message");

  if (form && errorMessage && successMessage) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(form);

      errorMessage.textContent = "";
      errorMessage.classList.add("hidden");
      successMessage.textContent = "";
      successMessage.classList.add("hidden");

      try {
        const formDataSearchParams = new URLSearchParams();
        for (const pair of formData.entries()) {
          formDataSearchParams.append(pair[0], pair[1] as string);
        }

        const response = await fetch("/api/users/signin", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: formDataSearchParams,
        });

        if (response.ok) {
          const { access_token } = await response.json();
          localStorage.setItem("token", access_token);

          successMessage.textContent = "ACCESS GRANTED. REDIRECTING...";
          successMessage.classList.remove("hidden");

          setTimeout(() => {
            window.location.href = "/";
          }, 1000);
        } else {
          const errorData = await response.json();
          let msg = "ACCESS DENIED.";
          if (errorData.detail) {
            if (Array.isArray(errorData.detail)) {
              msg = errorData.detail.map((e: any) => e.msg).join(", ");
            } else if (typeof errorData.detail === "string") {
              msg = errorData.detail;
            } else {
              msg = JSON.stringify(errorData.detail);
            }
          }
          errorMessage.textContent = msg;
          errorMessage.classList.remove("hidden");
        }
      } catch (error) {
        errorMessage.textContent = "SYSTEM ERROR. CONNECTION FAILED.";
        errorMessage.classList.remove("hidden");
        console.error(error);
      }
    });
  }
</script>
